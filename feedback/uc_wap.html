<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="format-detection" content="telephone=no" />
    <title>Document</title>
    <!-- <link rel="stylesheet" href="./css/oauthBase.css">-->
    <!-- <link rel="stylesheet" href="./css/oauthUcenter.css">-->
    <!-- <link rel="stylesheet" href="./css/oauthFeedback.css">-->
    <!-- sentry监控 -->
    <!-- <script src="./js/sentry.min.js" crossorigin="anonymous"></script>
 <script type="text/javascript">
 window.onload = function(){
 Sentry.init({ dsn: 'https://d925cd9da09446ffbc1befec08362d15@ky.3304399.net/20' });
 }
 </script> -->
    <script type="text/javascript" src="http://chenyiti.t2.s.img4399.com/BOOK/resource/?file=feedback%2Fwap%2Fjs%2Fzepto.min%2CimageResizer.js&v=_IMG_VERSION_CUR_"></script>
    <link
        href="http://chenyiti.t2.s.img4399.com/BOOK/resource/?file=feedback%2Fwap%2Fcss%2FoauthBase%2CoauthUcenter%2CoauthFeedback.css&v=_IMG_VERSION_CUR_"
        type="text/css" rel="stylesheet" />
</head>

<body>
    <div class="u-head">
        <h2>登录注册问题</h2>
    </div>
    <div class="u-container feedback">
        <div class="u-section">
            <form class="u-form">
                <div class="form-group form-group-vertical form-group-logintype">
                    <label class="form-label">
                        <span>请选择您要反馈的登录方式（选填）</span>
                    </label>
                    <div class="u-radio-group clearfix" id="radiolist">
                        <div class="radio-wrapper">
                            <input type="radio" class="radio-input" name="type" id="radio1" value="1">
                            <label for="radio1">4399账号</label>
                        </div>
                        <div class="radio-wrapper">
                            <input type="radio" class="radio-input" name="type" id="radio2" value="2">
                            <label for="radio2">手机号</label>
                        </div>
                        <div class="radio-wrapper">
                            <input type="radio" class="radio-input" name="type" id="radio3" value="3">
                            <label for="radio3">微信</label>
                        </div>
                    </div>
                </div>
                <div class="form-group form-group-vertical form-group-id">
                    <label class="form-label">
                        <span>反馈帐号（选填）</span>
                    </label>
                    <div class="form-control">
                        <input class="" type="text" name="id" placeholder="请输入您要反馈的4399帐号">
                    </div>
                </div>
                <div class="form-group form-group-vertical form-group-id">
                    <label class="form-label">
                        <span>反馈帐号（选填）</span>
                    </label>
                    <div class="form-control">
                        <input class="" type="text" name="id" placeholder="请输入您要反馈的手机号">
                    </div>
                </div>
                <div class="form-group form-group-vertical">
                    <label class="form-label" for="">
                        <span>问题描述（必填）</span>
                    </label>
                    <div class="textarea-wrapper">
                        <textarea class="form-control" name="descr" id="" cols="30" rows="5"
                            placeholder="请详细描述出现的异常，方便我们快速解决问题"></textarea>
                        <div class="textarea-count">
                            <span>0</span>
                            /500
                        </div>
                        <div class="feedback-file">
                            <div class="file-field">
                                <div class="file-origin">
                                    <div class="file-plus">
                                        <i></i>
                                        问题截图
                                    </div>
                                </div>
                                <input class="" type="file" name="file1" id="file1">
                                <div class="file-loading">加载中...</div>
                                <div class="file-img">
                                    <i></i>
                                    <img src="" alt="" id="file_img1">
                                </div>
                            </div>
                        </div>
                        <div class="feedback-file">
                            <div class="file-field">
                                <div class="file-origin">
                                    <div class="file-plus">
                                        <i></i>
                                        问题截图
                                    </div>
                                </div>
                                <input class="" type="file" name="file2" id="file2">
                                <div class="file-loading">加载中...</div>
                                <div class="file-img">
                                    <i></i>
                                    <img src="" alt="" id="file_img2">
                                </div>
                            </div>
                        </div>
                        <div class="feedback-file">
                            <div class="file-field">
                                <div class="file-origin">
                                    <div class="file-plus">
                                        <i></i>
                                        问题截图
                                    </div>
                                </div>
                                <input class="" type="file" name="file3" id="file3">
                                <div class="file-loading">加载中...</div>
                                <div class="file-img">
                                    <i></i>
                                    <img src="" alt="" id="file_img3">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-group form-group-vertical">
                    <label class="form-label">
                        <span>联系方式（选填）</span>
                    </label>
                    <div class="form-control">
                        <input class="" type="text" name="contact" placeholder="请留下您的QQ或手机号，方便我们更快地解决问题">
                    </div>
                </div>
                <div class="form-group-btn">
                    <button type="button" class="btn btn-primary disable j-submit">提交</button>
                </div>
            </form>
        </div>
    </div>
    <!--<script src="./js/zepto.min.js"></script>-->
    <!--<script src="./js/ajaxfileupload.js"></script>-->
    <script src="http://cdn.bootcss.com/vConsole/3.3.4/vconsole.min.js"></script>
    <script>
    // 初始化
    var vConsole = new VConsole();
    </script>
    <script>
        (function () {
            var _is = $.fn.is,
                _filter = $.fn.filter;

            //模拟radiobox
            $.fn.hradio = function (options) {
                var self = this;
                return $('label', this).each(function () {
                    if ($(this).prev().is("checked"))
                        $(this).addClass('radio-checked');
                }).click(function (event) {
                    $(this).parent().siblings().find('label').removeClass("radio-checked");
                    if (!$(this).prev().is(':checked')) {
                        $(this).addClass("radio-checked");
                        $(this).prev()[0].checked = true;
                        options.callback && options.callback($(this).prev());
                    }
                    event.stopPropagation();
                }).prev().hide();
            }

            //模拟:visible
            $.fn.filter = function (sel) {
                if (sel === ":visible") {
                    return $([].filter.call(this, visible));
                }
                if (sel === ":hidden") {
                    return $([].filter.call(this, function (elem) {
                        return !visible(elem);
                    }));
                }
                return _filter.call(this, sel);
            }

            function visible(elem) {
                elem = $(elem);
                return !!(elem.width() || elem.height()) && elem.css("display") !== "none";
            }

            /**
             * 函数节流
             * @param {*} doSomething
             * @param {*} wait
             */
            function throttle(doSomething, wait) {
                var timeout, _this, _arguments, previous = 0;

                var later = function (_this) {
                    previous = +new Date();
                    timeout = null;
                    doSomething.apply(_this, _arguments);
                };
                var throttled = function () {
                    var now = +new Date();
                    //下次触发 doSomething 剩余的时间
                    var remaining = wait - (now - previous),
                        _this = this;
                    _arguments = arguments;
                    // 如果没有剩余的时间了
                    if (remaining <= 0) {
                        if (timeout) {
                            clearTimeout(timeout);
                            timeout = null;
                        }
                        previous = now;
                        doSomething.apply(_this, _arguments);
                    } else if (!timeout) {
                        timeout = setTimeout(function () {
                            later(_this);
                        }, remaining);
                    }
                };
                return throttled;
            }

            /**
             * 简易toast
             * @param {*} text
             */
            function toast(text) {
                var $toast = $(".u-toast");
                if ($toast.length > 0) {
                    return false;
                }
                $("body").append("<div class='u-toast'><div class=\"toast-tit\">" + text + "</div></div>");
                setTimeout(function () {
                    $toast = $(".u-toast");
                    if ($toast.length > 0)
                        $toast.remove();
                }, 2000);
            }

            /**
             * 扩展数组indexOf方法
             * @param {*}
             */
            Array.prototype._indexOf = function (n) {
                if ("indexOf" in this) {
                    return this["indexOf"](n);
                }
                for (var i = 0; i < this.length; i++) {
                    if (n === this[i]) {
                        return i;
                    }
                }
                return -1;
            };

            var Page = {
                fileUploads: [],
                init: function (params) {
                    var page = this;

                    page.form = $(".u-form")[0];
                    page.bind();

                    //绑定模拟radiobox
                    $('#radiolist').hradio({
                        callback: function ($ele) {
                            var showIdFieldType = [1, 2];
                            var value = parseInt($ele.val());
                            $(".form-group-id").hide();
                            if (showIdFieldType.indexOf(value) >= 0) {
                                $(".form-group-id").eq(value - 1).show();
                            }
                        }
                    });

                    //初始化图片域
                    $(".feedback-file").each(function (index, el) {
                        page.initFileUpload(el, index);
                        page.fileUploads.push(el);
                    });
                    $(page.fileUploads.shift()).show();

                },
                bind: function (params) {
                    var page = this;

                    //输入框事件
                    $("textarea.form-control").on("input propertychange", function () {
                        var $this = $(this),
                            val = $this.val(),
                            count = "";

                        $(".j-submit").removeClass("disable");
                        if ((val.length <= 0) || (val == "请详细描述出现的异常，方便我们快速解决问题")) {
                            $(".j-submit").addClass("disable");
                        }
                        if (val.length > 500) {
                            $this.val(val.substring(0, 500));
                        }
                        count = val.length;
                        $(".textarea-count span").text(count);
                    });

                    //提交事件
                    $(".j-submit").bind("click", throttle(function () {
                        if ($(this).hasClass("disable")) {
                            return false;
                        }
                        // var _files = [];
                        // $(".feedback-file .file-img img").each(function (i, ele) {
                        //     var _fileid = $(ele).attr("fileid")
                        //     if (_fileid) {
                        //         _files.push(_fileid);
                        //     }
                        // });
                        var file_img = '';
                        var file_img1 = $("#file_img1").attr('src');
                        var file_img2 = $("#file_img2").attr('src');
                        var file_img3 = $("#file_img3").attr('src');
                        if (file_img1) {
                            file_img += file_img1;
                        }
                        if (file_img2) {
                            file_img += ';' + file_img2;
                        }
                        if (file_img3) {
                            file_img += ';' + file_img3;
                        }
                        var params = {
                            type: $(".form-group-logintype input:checked").val(),
                            id: $.trim($(".form-group-id").filter(":visible").find("input")
                                .val()),
                            descr: $.trim($(page.form.descr).val()),
                            contact: $.trim($(page.form.contact).val()),
                            channel: '游拍',
                            pid: '1',
                            // files : _files
                            file_img: file_img
                        };
                        
                        $.ajax({
                            url: "submit",
                            data: params,
                            type: "POST",
                            dataType: 'json',
                            success: function (res) {
                                if (res.code == 100) {
                                    toast(res.msg);
                                    page.reset();
                                } else {
                                    toast(res.msg);
                                }
                            },
                            error: function (error) {
                                toast("提交失败");
                            }
                        });
                    }, 1000));
                },

                //初始化图片域
                initFileUpload: function (fileWrap, index) {
                    var page = this;
                    var $fileWrap = $(fileWrap);
                    var $fileInput = $fileWrap.find("input");
                    var $fileImg = $fileWrap.find(".file-img");
                    var $fileField = $fileWrap.find(".file-field");

                    $fileImg.find("img")[0].onload = function (params) {
                        $fileField.removeClass("loading");
                        //显示下一个图片域
                        var hasUploadFieldEmpty = false;
                        $(".feedback-file").filter(":visible").find("img").each(
                            function (i, ele) {
                                if ($(ele).attr("src") == "") {
                                    hasUploadFieldEmpty = true;
                                    return false;
                                }
                            })
                        if (!hasUploadFieldEmpty && (page.fileUploads.length > 0)) {
                            $(page.fileUploads.shift()).show();
                        }
                    }
                    $fileInput.change(throttle(function (e) {
                        
                        if (typeof FormData !== "function") {
                            toast("请升级您的浏览器");
                            return false
                        }
                        if ($fileField.hasClass("loading")) {
                            return false
                        }
                        
                        if ($fileInput.val() == "") {
                            return false
                        }
                        
                        $fileImg.find("img").attr({"src": ""});

                        var file = $fileInput[0].files[0];

                        if (!page.imageFormatCheck(this)) {
                            toast("文件格式错误");
                            return false
                        }
                        if (file.size / 1024 / 1024 > 8) {
                            toast("文件大小超出限制");
                            return false
                        }

                        $fileField.addClass("loading");

                        //压缩图片
                        ImageResizer({
                            resizeMode:"auto",
                            dataSource:file,
                            dataSourceType:"file",
                            maxWidth:800, //允许的最大宽度
                            maxHeight:800, //允许的最大高度
                            onTmpImgGenerate:function(img){ },
                            success:function(resizeImgBase64,canvas){
                                var blob = dataURLtoBlob(resizeImgBase64);
                                var defile = new window.File([blob], file.name, {type: file.type});
                                var formData = new FormData();
                                formData.append("file", defile);
                                $.ajax({
                                    url: "upload-upload",
                                    data: formData,
                                    type: "POST",
                                    dataType : 'json',
                                    async:false,
                                    processData: false,   //一定要写
                                    contentType: false,   //一定要写
                                    xhrFields: {
                                        withCredentials: true
                                    },
                                    crossDomain: true,
                                    enctype: 'multipart/form-data',
                                    success: function (res) {
                                        if (res.code == 100) {
                                            $fileImg.show().find("img").attr({
                                                "src": res.result
                                            });
                                        } else {
                                            $fileWrap.removeClass("loading");
                                            toast(res.msg);
                                        }
                                    },
                                    error: function () {
                                        $fileField.removeClass("loading");
                                        toast('文件上传失败！');
                                    }
                                });
                            }
                        });
                    },1000))
                },
                    
                //校验图片格式
                imageFormatCheck: function (ele) {
                    return /.(jpg|jpeg|png)$/.test(ele.value) ? true : false
                },

                //清空页面内容
                reset : function() {
                    var page = this;
                    $("input[type=text]").val("");
                    $("input[type=file]").val("");
                    $("textarea").val("");
                    $(".file-img img").attr("src","");
                    $(".file-img i").hide();
                    $(".feedback-file").eq(0).hide();
                    $(".feedback-file").eq(1).hide();
                    $(".feedback-file").eq(2).hide();
                    // $(".radio-checked").removeClass("radio-checked");
                    // $(".radio-checked").attr("checked",false);
                    // $(".form-group-id").hide();
                    $(".textarea-count span").html("0");
                    $(".j-submit").addClass("disable");
                   
                    page.fileUploads = [];
                    //初始化图片域
                    $(".feedback-file").each(function (index, el) {
                        page.fileUploads.push(el);
                    });
                    $(page.fileUploads.shift()).show();
                }
            }

            $(function (params) {
                Page.init();
            })
            window.Page = Page;
            
        })();

    </script>
</body>

</html>